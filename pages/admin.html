<!-- ============================================================
     FIL: pages/admin.html  (HEL FIL)
     AO 5/6 (FAS 1.2) — Admin UI: skapa skattjakt (lokalt, utan konto)
     AO 1/8 (FAS 1.5) — Admin: Leaflet-bas + kartcontainer + init
     NICE-TO-HAVE (FAS 2.1) — QR per checkpoint (UI hooks + container)
     PATCH (FAS 2.1) — ENKLARE FLOW: karta nära checkpoints + “Välj CP → klicka karta”
     Städning: JA
     Live preview: JA (kvar, men flyttad för bättre flow)
     Policy: UI-only, Leaflet via CDN (OK), fail-closed (inline errors), mobil-first
============================================================ -->
<!doctype html>
<html lang="sv">
<head>
  <!-- ==========================================================
       BLOCK 1 — Meta + CSS
  =========================================================== -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Skapa skattjakt</title>
  <meta name="description" content="Skapa en skattjakt lokalt utan konto." />
  <link rel="stylesheet" href="../styles/main.css" />

  <!-- ==========================================================
       BLOCK 1.1 — Leaflet CSS (CDN)  (AO 1/8)
  =========================================================== -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
</head>

<body>
  <!-- ==========================================================
       BLOCK 2 — Skip link (A11y)
  =========================================================== -->
  <a class="skipLink" href="#mainContent">Hoppa till innehåll</a> <!-- HOOK: skip-link -->

  <!-- ==========================================================
       BLOCK 3 — App Root
  =========================================================== -->
  <div id="app" class="app"> <!-- HOOK: app-root -->

    <!-- ========================================================
         BLOCK 4 — Header
    ========================================================= -->
    <header class="topbar">
      <div class="topbar__inner">
        <div class="row row--header">
          <button id="backBtn" class="btn btn-ghost btn--icon" type="button" aria-label="Tillbaka">
            ←
          </button>
          <!-- HOOK: back-button -->

          <div class="headerTitle">
            <div class="muted small">Admin</div>
            <div class="headerName">Skapa skattjakt</div>
          </div>

          <div class="headerRight">
            <span id="savePill" class="pill pill--level" aria-live="polite">Utkast</span>
            <!-- HOOK: save-pill -->
          </div>
        </div>
      </div>
    </header>

    <!-- ========================================================
         BLOCK 5 — Main
    ========================================================= -->
    <main id="mainContent" class="main" role="main"> <!-- HOOK: main -->
      <div class="container">
        <!-- Status / error slot -->
        <div id="statusSlot" class="slot" aria-live="polite"></div> <!-- HOOK: status-slot -->

        <!-- ======================================================
             BLOCK 6 — Arbetsyta (NY LAYOUT)
             Mål: Kartan nära checkpoints (desktop: sticky höger, mobil: direkt efter editor)
        ======================================================= -->
        <div class="adminGrid">
          <!-- =========================
               BLOCK 6.1 — Vänster: Form + Checkpoints editor
          ========================== -->
          <section class="card" aria-label="Skapa jakt">
            <div class="card__head">
              <div class="card__meta">
                <h1 class="h2" style="margin:0">Skapa jakt</h1>
                <p class="muted small" style="margin:6px 0 0 0">
                  Rekommenderat flöde: <b>Välj checkpoint → klicka på karta</b> → skriv ledtråd/kod/radius.
                </p>
              </div>
            </div>

            <form id="partyForm" class="form" novalidate>
              <!-- HOOK: party-form -->

              <!-- Jaktens namn -->
              <div class="field">
                <label class="label2" for="partyNameInput">Jaktens namn</label>
                <input id="partyNameInput" name="partyName" class="input"
                       type="text" autocomplete="off" placeholder="Ex: Kalas hos Alex" />
                <!-- HOOK: party-name-input -->
                <div id="errPartyName" class="errorText" role="alert"></div>
                <!-- HOOK: err-party-name -->
              </div>

              <!-- Antal checkpoints -->
              <div class="field">
                <label class="label2" for="cpCountInput">Antal checkpoints (1–20)</label>
                <input id="cpCountInput" name="checkpointCount" class="input"
                       type="number" inputmode="numeric" min="1" max="20" step="1" />
                <!-- HOOK: checkpoint-count-input -->
                <div id="errCpCount" class="errorText" role="alert"></div>
                <!-- HOOK: err-checkpoint-count -->
              </div>

              <!-- Poäng per checkpoint -->
              <div class="field">
                <label class="label2" for="pointsPerInput">Poäng per checkpoint</label>
                <input id="pointsPerInput" name="pointsPerCheckpoint" class="input"
                       type="number" inputmode="numeric" min="0" max="1000" step="1" />
                <!-- HOOK: points-per-input -->
                <div id="errPointsPer" class="errorText" role="alert"></div>
                <!-- HOOK: err-points-per -->
              </div>

              <!-- Ledtrådar / Checkpoints -->
              <div class="field">
                <div class="rowBetween">
                  <label class="label2" for="cluesWrap">Checkpoints (klicka en CP för att välja)</label>
                  <div class="miniRow">
                    <button id="addCpBtn" class="btn btn-ghost miniBtn" type="button">+ checkpoint</button>
                    <!-- HOOK: add-cp -->
                    <button id="removeCpBtn" class="btn btn-ghost miniBtn" type="button">− checkpoint</button>
                    <!-- HOOK: remove-cp -->
                  </div>
                </div>

                <!-- Aktiv CP hint (JS sätter) -->
                <div class="activeHint muted small" aria-live="polite">
                  Aktiv: <span id="activeCpLabel">—</span>
                  <!-- HOOK: active-cp-label -->
                </div>

                <div id="cluesWrap" class="cluesWrap" aria-label="Checkpoints editor">
                  <!-- HOOK: clues-wrap (JS renderar cp-rader) -->
                </div>

                <div id="errClues" class="errorText" role="alert"></div>
                <!-- HOOK: err-clues -->
              </div>

              <div class="rowBetween" style="margin-top:14px">
                <button id="resetBtn" class="btn btn-ghost" type="button">
                  Rensa utkast
                </button>
                <!-- HOOK: reset-draft -->

                <button id="saveBtn" class="btn btn-primary" type="button">
                  Spara utkast
                </button>
                <!-- HOOK: save-draft -->
              </div>

              <p class="muted small" style="margin-top:10px">
                Export (länk/JSON) + QR per checkpoint ligger längre ned.
              </p>
            </form>
          </section>

          <!-- =========================
               BLOCK 6.2 — Höger: Karta (sticky)
          ========================== -->
          <section class="card stickyCard" aria-label="Karta">
            <div class="card__head">
              <div class="card__meta">
                <h2 class="h2" style="margin:0">Karta</h2>
                <p class="muted small" style="margin:6px 0 0 0">
                  <b>Välj checkpoint</b> i listan → <b>klicka på kartan</b> för att sätta plats.
                </p>
              </div>
            </div>

            <div class="mapHintRow">
              <span class="badge">Tips</span>
              <span id="mapHint" class="muted small">
                Välj en checkpoint för att aktivera kart-klick.
              </span>
              <!-- HOOK: map-hint -->
            </div>

            <div id="mapWrap" class="mapWrap">
              <div id="map" class="map" role="application" aria-label="Karta"></div>
              <!-- HOOK: map-container -->
              <div id="mapError" class="errorText" role="alert"></div>
              <!-- HOOK: map-error -->
            </div>
          </section>
        </div>

        <!-- ======================================================
             BLOCK 7 — Live preview (kvar, flyttad under arbetsytan)
        ======================================================= -->
        <section class="card" aria-label="Live preview" style="margin-top: var(--sp-4);">
          <div class="card__head">
            <div class="card__meta">
              <h2 class="h2" style="margin:0">Live preview</h2>
              <p class="muted small" style="margin:6px 0 0 0">
                Så här ser checkpoints ut (uppdateras direkt).
              </p>
            </div>
          </div>

          <div class="preview">
            <div class="previewTop">
              <div class="label muted">Jakt</div>
              <div id="previewName" class="value">—</div>
              <!-- HOOK: preview-name -->
            </div>

            <div class="previewTop" style="margin-top:10px">
              <div class="label muted">Poäng/checkpoint</div>
              <div id="previewPoints" class="value">—</div>
              <!-- HOOK: preview-points -->
            </div>

            <div class="previewListHead">
              <div class="label muted">Checkpoints</div>
              <div id="previewCount" class="muted small">0</div>
              <!-- HOOK: preview-count -->
            </div>

            <ol id="previewList" class="previewList">
              <!-- HOOK: preview-list -->
            </ol>
          </div>
        </section>

        <!-- ======================================================
             BLOCK 7.6 — QR per checkpoint (NICE)
        ======================================================= -->
        <section class="card" aria-label="QR per checkpoint" style="margin-top: var(--sp-4);">
          <div class="card__head">
            <div class="card__meta">
              <h2 class="h2" style="margin:0">QR per checkpoint</h2>
              <p class="muted small" style="margin:6px 0 0 0">
                Valfritt: visa en QR för varje checkpoint (scanna → öppna jakt + ev. förifyll cp/kod).
              </p>
            </div>
          </div>

          <div id="qrSlot" class="qrSlot">
            <!-- HOOK: qr-slot (JS renderar cp-rader med QR + copy) -->
          </div>

          <div id="qrError" class="errorText" role="alert"></div>
          <!-- HOOK: qr-error -->
        </section>

        <div class="muted small footerNote">
          Admin kör lokalt (ingen inloggning). Utkast sparas på en stabil localStorage-key.
        </div>
      </div>
    </main>
  </div>

  <!-- ==========================================================
       BLOCK 8 — Page-only styles (inline ok)
       Städning: JA (rensar gamla grid2/map-sektioner och samlar layout här)
  =========================================================== -->
  <style>
    .row { display:flex; align-items:center; gap: var(--sp-3); }
    .row--header { width:100%; }
    .rowBetween { display:flex; align-items:flex-start; justify-content:space-between; gap: var(--sp-3); }
    .miniRow { display:flex; gap: 8px; flex-wrap: wrap; }

    .btn--icon { width:44px; padding: 10px 10px; }
    .headerTitle { flex: 1; min-width: 0; }
    .headerName { font-weight: 800; font-size: var(--fs-4); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .headerRight { display:flex; align-items:center; gap: var(--sp-2); }

    .pill { display:inline-flex; align-items:center; justify-content:center; padding: 7px 10px; border-radius: 999px; border: 1px solid var(--border); background: rgba(255,255,255,.06); font-weight: 800; font-size: var(--fs-1); }
    .pill--level { border-color: rgba(110,231,255,.30); background: rgba(110,231,255,.10); color: rgba(255,255,255,.92); }

    .slot { margin-top: var(--sp-4); }

    /* Ny layout: form/editor + karta nära */
    .adminGrid { display:grid; gap: var(--sp-4); margin-top: var(--sp-4); }
    @media (min-width: 980px) {
      .adminGrid { grid-template-columns: 1.15fr .85fr; align-items:start; }
    }

    .stickyCard { position: relative; }
    @media (min-width: 980px) {
      .stickyCard { position: sticky; top: 84px; } /* under topbar */
    }

    .mapHintRow { margin-top: 10px; display:flex; align-items:center; gap: 10px; flex-wrap: wrap; }
    .activeHint { margin-top: 8px; }

    .form { margin-top: 12px; display:grid; gap: 14px; }
    .field { display:grid; gap: 6px; }
    .label2 { font-weight: 800; font-size: var(--fs-2); }
    .input {
      min-height: 44px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      outline: none;
    }
    .input::placeholder { color: rgba(255,255,255,.45); }
    .input:focus-visible { box-shadow: var(--focus); }

    .errorText {
      min-height: 18px;
      font-size: var(--fs-2);
      color: rgba(251,113,133,.95);
    }

    .miniBtn { padding: 10px 12px; min-height: 44px; }

    .cluesWrap { display:grid; gap: 8px; margin-top: 6px; }
    .clueRow { display:grid; gap: 6px; }
    .clueMeta { display:flex; align-items:center; justify-content:space-between; gap: 12px; }
    .clueIdx { font-weight: 900; }
    .clueInput { width: 100%; }

    .preview { display:grid; gap: 10px; }
    .previewTop { display:flex; align-items:baseline; justify-content:space-between; gap: 12px; }
    .previewListHead { display:flex; align-items:baseline; justify-content:space-between; gap: 12px; margin-top: 6px; }
    .previewList { margin: 0; padding-left: 18px; display:grid; gap: 8px; }
    .previewItem {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.04);
    }

    /* Map container needs height */
    .mapWrap { margin-top: 10px; display:grid; gap: 8px; }
    .map {
      width: 100%;
      min-height: 320px; /* mobil */
      border-radius: 14px;
      border: 1px solid var(--border);
      overflow: hidden;
      background: rgba(255,255,255,.03);
    }
    @media (min-width: 980px) {
      .map { min-height: 520px; }
    }

    /* NICE — QR slot container */
    .qrSlot { margin-top: 12px; display:grid; gap: 10px; }
    .qrRow {
      display:grid;
      gap: 8px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
    }
    .qrRowTop { display:flex; align-items:center; justify-content:space-between; gap: 10px; }
    .qrTitle { font-weight: 900; }
    .qrActions { display:flex; gap: 8px; flex-wrap: wrap; }
    .qrImg {
      width: 180px;
      height: 180px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.15);
      display:none;
    }

    .footerNote { margin-top: var(--sp-6); text-align:center; opacity:.85; }
  </style>

  <!-- ==========================================================
       BLOCK 9 — Scripts
  =========================================================== -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script type="module" src="../src/admin-map.js"></script>
  <script type="module" src="../src/admin.js"></script>
</body>
</html>
