<!-- ============================================================
     FIL: pages/dashboard.html  (HEL FIL)
     AO 6/6 — Stats + riktig admin-lista (partners/rewards/vouchers)
     Bygger på Worker endpoints:
       - GET  /admin/partners/list
       - GET  /admin/stats/overview?windowHours=...
       - GET  /admin/stats/partner/:partnerId?windowHours=...
       - GET  /admin/partners/:partnerId/rewards
       - POST /admin/partners/create
       - POST /admin/partners/invite
     Policy: UI-only, fail-closed, ingen storage för admin key, XSS-safe (textContent)
============================================================ -->
<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>
  <meta name="description" content="Admin dashboard för partners, rewards och vouchers." />
  <link rel="stylesheet" href="../styles/main.css" />

  <!-- Page-local fix: vita texter i inputs/select (som på din screenshot) -->
  <style>
    /* ==========================================================
       AO 6/6 — Input/Select text ska vara vit (fix)
    =========================================================== */
    .input, select.input, .input[type="text"], .input[type="password"], .input[type="number"]{
      color: rgba(255,255,255,.92) !important;
      -webkit-text-fill-color: rgba(255,255,255,.92) !important;
      caret-color: rgba(255,255,255,.92);
    }
    .input::placeholder{
      color: rgba(255,255,255,.45) !important;
      -webkit-text-fill-color: rgba(255,255,255,.45) !important;
    }

    /* Select: visad vald text vit, dropdown options läsbara */
    select.input { background: rgba(255,255,255,.05); }
    select.input option{
      color: #111;
      background: #fff;
    }

    /* Layout helpers (page-local, minimal) */
    .dashGrid { display:grid; gap: 14px; }
    @media (min-width: 900px){ .dashGrid--2 { grid-template-columns: 1fr 1fr; } }

    .row { display:flex; align-items:center; gap: 10px; flex-wrap:wrap; }
    .rowSpace { display:flex; align-items:center; justify-content:space-between; gap: 12px; flex-wrap:wrap; }

    .slot { margin-top: var(--sp-4); }
    .mini { font-size: var(--fs-2); }
    .muted2 { opacity:.85; }

    /* Lists */
    .list { list-style:none; padding:0; margin:0; display:grid; gap: 10px; }
    .listItem {
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      border-radius: 14px;
      padding: 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    .listItem__meta { min-width:0; display:grid; gap: 4px; }
    .listItem__title { font-weight: 900; }
    .listItem__sub { font-size: var(--fs-2); opacity:.9; }
    .listItem__right { display:flex; gap: 8px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }

    /* Badges (light) */
    .badge--ok { border-color: rgba(74,222,128,.45); background: rgba(74,222,128,.10); }
    .badge--warn { border-color: rgba(251,191,36,.35); background: rgba(251,191,36,.10); }
    .badge--off { border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.06); }

    /* Partner detail */
    .detailGrid { display:grid; gap: 12px; }
    @media (min-width: 900px){ .detailGrid { grid-template-columns: 1.1fr .9fr; } }

    .tableLite { width:100%; border-collapse: separate; border-spacing: 0 8px; }
    .tableLite th { text-align:left; font-size: var(--fs-2); opacity:.85; padding: 0 8px; }
    .tableLite td { padding: 10px 8px; background: rgba(255,255,255,.05); border:1px solid var(--border); }
    .tableLite td:first-child { border-radius: 12px 0 0 12px; }
    .tableLite td:last-child { border-radius: 0 12px 12px 0; }
    .num { text-align:right; }

    /* Toast slot uses existing .toast in main.css if present */
    .toast { margin-top: 10px; }
  </style>
</head>

<body class="theme-party">
  <div id="app" class="app">
    <!-- Topbar -->
    <header class="topbar">
      <div class="topbar__inner">
        <div class="brand">
          <div class="brand__mark" aria-hidden="true">◎</div>
          <div class="brand__text">
            <div class="brand__name">Admin Dashboard</div>
            <div class="brand__tag muted">session: <span id="sessionId">—</span></div>
          </div>
        </div>

        <div class="topbar__right" style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <a class="badge" href="admin.html?new=1" aria-label="Öppna admin">Admin</a>
          <a class="badge" href="partner.html" aria-label="Öppna partner-sida">Partner</a>
          <span class="badge badge-success" aria-label="MVP status">MVP</span>
        </div>
      </div>
    </header>

    <main class="main" role="main">
      <div class="container">
        <!-- Status slot -->
        <div id="statusSlot" class="slot" aria-live="polite"></div>

        <!-- Admin key card -->
        <section class="card paperCard" aria-label="Admin Key">
          <div class="card__head">
            <div class="card__meta">
              <h1 class="h2" style="margin:0">Admin Key</h1>
              <p class="muted small" style="margin:6px 0 0 0">Admin key lagras inte. Den används bara i minnet för requests.</p>
            </div>
            <div class="card__side">
              <button id="fetchBtn" class="btn btn-ghost" type="button" aria-label="Hämta data">Hämta data</button>
            </div>
          </div>

          <div class="form" style="margin-top:12px">
            <div class="field" style="max-width:420px">
              <label class="label2" for="adminKeyInput">Admin Key</label>
              <input id="adminKeyInput" class="input" type="password" placeholder="••••" autocomplete="off" />
            </div>
            <div class="muted small">
              Klicka “Hämta data” för att lista partners + stats. (fail-closed om key saknas/fel.)
            </div>
          </div>
        </section>

        <div class="dashGrid dashGrid--2" style="margin-top:14px">
          <!-- Create partner -->
          <section class="card paperCard" aria-label="Skapa butik">
            <div class="card__head">
              <div class="card__meta">
                <h2 class="h2" style="margin:0">Skapa butik</h2>
                <p class="muted small" style="margin:6px 0 0 0">Skapar partner i backend.</p>
              </div>
            </div>

            <div class="form" style="margin-top:12px">
              <div class="field">
                <label class="label2" for="createPartnerId">PartnerId</label>
                <input id="createPartnerId" class="input" type="text" placeholder="t.ex butik-123" autocomplete="off" />
              </div>
              <div class="field">
                <label class="label2" for="createPartnerName">Namn</label>
                <input id="createPartnerName" class="input" type="text" placeholder="t.ex Café Nova" autocomplete="off" />
              </div>
              <button id="createPartnerBtn" class="btn btn-primary" type="button">Skapa</button>
            </div>
          </section>

          <!-- Invite partner -->
          <section class="card paperCard" aria-label="Bjud in butik">
            <div class="card__head">
              <div class="card__meta">
                <h2 class="h2" style="margin:0">Bjud in butik</h2>
                <p class="muted small" style="margin:6px 0 0 0">Skapar invite-token till partner.</p>
              </div>
            </div>

            <div class="form" style="margin-top:12px">
              <div class="field">
                <label class="label2" for="invitePartnerSelect">PartnerId</label>
                <select id="invitePartnerSelect" class="input" aria-label="Välj partner">
                  <option value="">— välj partner —</option>
                </select>
              </div>
              <div class="field" style="max-width:220px">
                <label class="label2" for="inviteTtl">TTL (min)</label>
                <input id="inviteTtl" class="input" type="number" inputmode="numeric" value="10080" min="1" max="43200" />
              </div>

              <button id="createInviteBtn" class="btn btn-primary" type="button">Skapa invite</button>

              <div class="field" style="margin-top:6px">
                <label class="label2" for="inviteUrlInput">Invite-länk</label>
                <input id="inviteUrlInput" class="input" type="text" readonly value="" />
                <div class="row">
                  <button id="inviteCopyBtn" class="btn btn-ghost miniBtn" type="button">Kopiera</button>
                  <span id="inviteMsg" class="muted small" style="min-height:18px"></span>
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- Overview + Partners + Detail -->
        <div class="dashGrid" style="margin-top:14px">
          <!-- Overview -->
          <section class="card paperCard" aria-label="Översikt">
            <div class="card__head">
              <div class="card__meta">
                <h2 class="h2" style="margin:0">Översikt</h2>
                <p class="muted small" style="margin:6px 0 0 0">Hämtas från <code>/admin/stats/overview</code>.</p>
              </div>
              <div class="card__side row">
                <label class="muted small" for="windowHoursSelect">Fönster</label>
                <select id="windowHoursSelect" class="input" style="min-width:140px">
                  <option value="1">1h</option>
                  <option value="24" selected>24h</option>
                  <option value="168">168h</option>
                </select>
              </div>
            </div>

            <div class="dashGrid dashGrid--2" style="margin-top:12px">
              <div class="card" style="padding:12px">
                <div class="muted small">Vouchers skapade</div>
                <div id="ovCreated" style="font-weight:900; font-size:26px; margin-top:6px;">—</div>
              </div>
              <div class="card" style="padding:12px">
                <div class="muted small">Vouchers inlösta</div>
                <div id="ovRedeemed" style="font-weight:900; font-size:26px; margin-top:6px;">—</div>
              </div>
              <div class="card" style="padding:12px">
                <div class="muted small">Unika gameIds</div>
                <div id="ovUnique" style="font-weight:900; font-size:26px; margin-top:6px;">—</div>
              </div>
              <div class="card" style="padding:12px">
                <div class="muted small">Topp</div>
                <div class="muted small" style="margin-top:6px">Partners + Rewards (Top 5)</div>
              </div>
            </div>

            <div class="dashGrid dashGrid--2" style="margin-top:12px">
              <div class="card" style="padding:12px">
                <div class="rowSpace">
                  <div class="listItem__title">Top Partners</div>
                  <span class="badge badge--off">created/redeemed</span>
                </div>
                <ul id="topPartnersList" class="list" style="margin-top:10px"></ul>
              </div>
              <div class="card" style="padding:12px">
                <div class="rowSpace">
                  <div class="listItem__title">Top Rewards</div>
                  <span class="badge badge--off">created/redeemed</span>
                </div>
                <ul id="topRewardsList" class="list" style="margin-top:10px"></ul>
              </div>
            </div>
          </section>

          <!-- Partners -->
          <section class="card paperCard" aria-label="Partners">
            <div class="card__head">
              <div class="card__meta">
                <h2 class="h2" style="margin:0">Partners</h2>
                <p class="muted small" style="margin:6px 0 0 0">Lista från <code>/admin/partners/list</code>. Klicka en partner för details.</p>
              </div>
            </div>

            <ul id="partnersList" class="list" style="margin-top:12px"></ul>
          </section>

          <!-- Partner detail -->
          <section id="partnerDetailCard" class="card paperCard" aria-label="Partner detail">
            <div class="card__head">
              <div class="card__meta">
                <h2 class="h2" style="margin:0">Partner detail</h2>
                <p id="partnerDetailSub" class="muted small" style="margin:6px 0 0 0">Välj en partner i listan.</p>
              </div>
            </div>

            <div class="detailGrid" style="margin-top:12px">
              <div class="card" style="padding:12px">
                <div class="rowSpace">
                  <div class="listItem__title">Rewards</div>
                  <span id="detailPartnerBadge" class="badge badge--off">—</span>
                </div>

                <div style="overflow:auto; margin-top:10px">
                  <table class="tableLite" aria-label="Rewards tabell">
                    <thead>
                      <tr>
                        <th>Title</th>
                        <th>Tier</th>
                        <th class="num">Stock</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody id="rewardsTbody"></tbody>
                  </table>
                </div>
              </div>

              <div class="card" style="padding:12px">
                <div class="rowSpace">
                  <div class="listItem__title">Stats</div>
                  <span class="badge badge--off">windowHours</span>
                </div>

                <div class="dashGrid" style="margin-top:10px">
                  <div class="card" style="padding:12px">
                    <div class="muted small">Created</div>
                    <div id="pCreated" style="font-weight:900; font-size:24px; margin-top:4px;">—</div>
                  </div>
                  <div class="card" style="padding:12px">
                    <div class="muted small">Redeemed</div>
                    <div id="pRedeemed" style="font-weight:900; font-size:24px; margin-top:4px;">—</div>
                  </div>
                  <div class="card" style="padding:12px">
                    <div class="muted small">Active rewards</div>
                    <div id="pActiveRewards" style="font-weight:900; font-size:24px; margin-top:4px;">—</div>
                  </div>
                  <div class="card" style="padding:12px">
                    <div class="muted small">Out of stock</div>
                    <div id="pOutStock" style="font-weight:900; font-size:24px; margin-top:4px;">—</div>
                  </div>
                </div>

                <div class="muted small" style="margin-top:10px">
                  Admin override (pause/stock) kommer senare.
                </div>
              </div>
            </div>
          </section>
        </div>

        <div class="muted small" style="margin-top:18px; text-align:center; opacity:.85;">
          AO 6/6 — Admin dashboard (UI-only). Admin key lagras inte.
        </div>
      </div>
    </main>
  </div>

  <script type="module">
    /* ============================================================
       BLOCK 1 — Konstanter + state
    ============================================================ */
    const API_BASE = 'https://uppdrag.andersmenyit.workers.dev';

    const $ = (id) => document.getElementById(id);

    const elStatusSlot = $('statusSlot');
    const elSessionId = $('sessionId');

    const elAdminKey = $('adminKeyInput');
    const elFetchBtn = $('fetchBtn');

    const elCreatePartnerId = $('createPartnerId');
    const elCreatePartnerName = $('createPartnerName');
    const elCreatePartnerBtn = $('createPartnerBtn');

    const elInvitePartnerSelect = $('invitePartnerSelect');
    const elInviteTtl = $('inviteTtl');
    const elCreateInviteBtn = $('createInviteBtn');
    const elInviteUrlInput = $('inviteUrlInput');
    const elInviteCopyBtn = $('inviteCopyBtn');
    const elInviteMsg = $('inviteMsg');

    const elWindowHours = $('windowHoursSelect');
    const elOvCreated = $('ovCreated');
    const elOvRedeemed = $('ovRedeemed');
    const elOvUnique = $('ovUnique');
    const elTopPartners = $('topPartnersList');
    const elTopRewards = $('topRewardsList');

    const elPartnersList = $('partnersList');

    const elPartnerDetailSub = $('partnerDetailSub');
    const elDetailPartnerBadge = $('detailPartnerBadge');
    const elRewardsTbody = $('rewardsTbody');

    const elPCreated = $('pCreated');
    const elPRedeemed = $('pRedeemed');
    const elPActiveRewards = $('pActiveRewards');
    const elPOutStock = $('pOutStock');

    const state = {
      adminKey: '',
      partners: [],
      selectedPartnerId: '',
      lastInviteUrl: ''
    };

    /* ============================================================
       BLOCK 2 — UI helpers (XSS-safe)
    ============================================================ */
    function setText(node, text) {
      if (!node) return;
      node.textContent = (text ?? '').toString();
    }

    function clearNode(node) {
      if (!node) return;
      while (node.firstChild) node.removeChild(node.firstChild);
    }

    function toast(msg, type = 'info') {
      if (!elStatusSlot) return;
      clearNode(elStatusSlot);
      const div = document.createElement('div');
      div.className = `toast toast--${type === 'danger' ? 'danger' : type === 'warn' ? 'warn' : type === 'success' ? 'success' : 'info'}`;
      div.setAttribute('role', 'status');
      div.textContent = (msg ?? '').toString();
      elStatusSlot.appendChild(div);
    }

    function requireKeyOrWarn() {
      const k = (elAdminKey && elAdminKey.value) ? String(elAdminKey.value) : '';
      state.adminKey = k.trim();
      if (!state.adminKey) {
        toast('Admin key saknas.', 'warn');
        return false;
      }
      return true;
    }

    function badge(text, variant) {
      const s = document.createElement('span');
      s.className = `badge ${variant || ''}`.trim();
      s.textContent = text;
      return s;
    }

    function currentBaseUrl() {
      // dashboard.html ligger i /pages/dashboard.html → base = repo-root
      try {
        const u = new URL(window.location.href);
        u.hash = '';
        u.search = '';
        u.pathname = u.pathname.replace(/\/pages\/[^/]+$/, '/');
        const s = u.toString();
        return s.endsWith('/') ? s.slice(0, -1) : s;
      } catch (_) {
        return (window.location.origin || '').toString();
      }
    }

    function buildInviteUrl(inviteToken) {
      const base = currentBaseUrl();
      const t = encodeURIComponent(String(inviteToken || ''));
      return `${base}/pages/partner.html?invite=${t}`;
    }

    async function copyText(text, fallbackInput) {
      const t = String(text || '');
      if (!t) return false;
      try {
        if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
          await navigator.clipboard.writeText(t);
          return true;
        }
      } catch (_) {}
      if (fallbackInput) {
        try {
          fallbackInput.focus();
          fallbackInput.select();
          fallbackInput.setSelectionRange(0, String(fallbackInput.value || '').length);
          document.execCommand('copy');
          return true;
        } catch (_) {}
      }
      return false;
    }

    /* ============================================================
       BLOCK 3 — API helpers (fail-closed)
    ============================================================ */
    async function apiGet(path) {
      const url = `${API_BASE.replace(/\/$/, '')}${path}`;
      const res = await fetch(url, {
        method: 'GET',
        headers: { 'x-admin-key': state.adminKey }
      });
      const data = await res.json().catch(() => null);
      return { ok: res.ok, status: res.status, data };
    }

    async function apiPost(path, body) {
      const url = `${API_BASE.replace(/\/$/, '')}${path}`;
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'content-type': 'application/json',
          'x-admin-key': state.adminKey
        },
        body: JSON.stringify(body || {})
      });
      const data = await res.json().catch(() => null);
      return { ok: res.ok, status: res.status, data };
    }

    function isDbMissingTable(payload) {
      return !!(payload && payload.ok === false && payload.error === 'db_missing_table');
    }

    /* ============================================================
       BLOCK 4 — Render: overview + top lists
    ============================================================ */
    function renderTopList(container, items, kind) {
      clearNode(container);
      const arr = Array.isArray(items) ? items : [];
      if (!arr.length) {
        const li = document.createElement('li');
        li.className = 'muted small';
        li.textContent = '—';
        container.appendChild(li);
        return;
      }

      arr.forEach((it) => {
        const li = document.createElement('li');
        li.className = 'listItem';

        const meta = document.createElement('div');
        meta.className = 'listItem__meta';

        const title = document.createElement('div');
        title.className = 'listItem__title';

        if (kind === 'partner') {
          title.textContent = `${String(it.name || it.partnerId || 'Partner')}`;
        } else {
          title.textContent = `${String(it.title || it.rewardId || 'Reward')}`;
        }

        const sub = document.createElement('div');
        sub.className = 'listItem__sub muted2';
        sub.textContent = kind === 'partner'
          ? `partnerId: ${String(it.partnerId || '—')}`
          : `rewardId: ${String(it.rewardId || '—')} • partnerId: ${String(it.partnerId || '—')}`;

        meta.appendChild(title);
        meta.appendChild(sub);

        const right = document.createElement('div');
        right.className = 'listItem__right';
        right.appendChild(badge(`${Number(it.created) || 0}/${Number(it.redeemed) || 0}`, 'badge--off'));

        li.appendChild(meta);
        li.appendChild(right);
        container.appendChild(li);
      });
    }

    function renderOverview(overview) {
      setText(elOvCreated, overview ? String(overview.vouchersCreated ?? '—') : '—');
      setText(elOvRedeemed, overview ? String(overview.vouchersRedeemed ?? '—') : '—');
      setText(elOvUnique, overview ? String(overview.uniqueGames ?? '—') : '—');

      renderTopList(elTopPartners, overview?.topPartners || [], 'partner');
      renderTopList(elTopRewards, overview?.topRewards || [], 'reward');
    }

    /* ============================================================
       BLOCK 5 — Render: partners list + invite select
    ============================================================ */
    function renderInviteSelect(partners) {
      if (!elInvitePartnerSelect) return;
      const selected = elInvitePartnerSelect.value || '';
      clearNode(elInvitePartnerSelect);

      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = '— välj partner —';
      elInvitePartnerSelect.appendChild(opt0);

      (partners || []).forEach((p) => {
        const opt = document.createElement('option');
        opt.value = String(p.partnerId || '');
        opt.textContent = String(p.partnerId || '');
        elInvitePartnerSelect.appendChild(opt);
      });

      // restore selection if possible
      elInvitePartnerSelect.value = selected;
    }

    function renderPartnersList(partners) {
      clearNode(elPartnersList);

      const arr = Array.isArray(partners) ? partners : [];
      if (!arr.length) {
        const li = document.createElement('li');
        li.className = 'muted small';
        li.textContent = 'Inga partners ännu.';
        elPartnersList.appendChild(li);
        return;
      }

      arr.forEach((p) => {
        const li = document.createElement('li');
        li.className = 'listItem';

        const meta = document.createElement('div');
        meta.className = 'listItem__meta';

        const title = document.createElement('div');
        title.className = 'listItem__title';
        title.textContent = String(p.name || '—');

        const sub = document.createElement('div');
        sub.className = 'listItem__sub muted2';
        sub.textContent = `partnerId: ${String(p.partnerId || '—')}`;

        meta.appendChild(title);
        meta.appendChild(sub);

        const right = document.createElement('div');
        right.className = 'listItem__right';

        const hasPin = Number(p.hasPin) === 1 || p.hasPin === true;
        const isActive = Number(p.isActive) === 1;

        right.appendChild(badge(hasPin ? 'PIN OK' : 'PIN saknas', hasPin ? 'badge--ok' : 'badge--warn'));
        right.appendChild(badge(isActive ? 'Aktiv' : 'Inaktiv', isActive ? 'badge--ok' : 'badge--off'));

        const btnView = document.createElement('button');
        btnView.type = 'button';
        btnView.className = 'btn btn-ghost miniBtn';
        btnView.textContent = 'Visa';
        btnView.addEventListener('click', () => selectPartner(String(p.partnerId || '')));

        const btnInvite = document.createElement('button');
        btnInvite.type = 'button';
        btnInvite.className = 'btn btn-ghost miniBtn';
        btnInvite.textContent = 'Skapa invite';
        btnInvite.addEventListener('click', () => {
          if (elInvitePartnerSelect) elInvitePartnerSelect.value = String(p.partnerId || '');
          createInvite();
        });

        right.appendChild(btnView);
        right.appendChild(btnInvite);

        li.appendChild(meta);
        li.appendChild(right);

        // click row selects partner (but not double-trigger)
        li.addEventListener('click', (e) => {
          const tag = (e?.target?.tagName || '').toUpperCase();
          if (tag === 'BUTTON') return;
          selectPartner(String(p.partnerId || ''));
        });

        elPartnersList.appendChild(li);
      });
    }

    /* ============================================================
       BLOCK 6 — Partner detail: rewards + partner stats
    ============================================================ */
    function rewardStatusLabel(r) {
      const isActive = Number(r.isActive) === 1;
      const stock = Number(r.stock) || 0;
      if (!isActive) return { text: 'Pausad', variant: 'badge--off' };
      if (stock <= 0) return { text: 'Slut', variant: 'badge--warn' };
      return { text: 'Aktiv', variant: 'badge--ok' };
    }

    function renderRewardsTable(rewards) {
      clearNode(elRewardsTbody);

      const arr = Array.isArray(rewards) ? rewards : [];
      if (!arr.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 4;
        td.style.borderRadius = '12px';
        td.textContent = 'Inga rewards.';
        tr.appendChild(td);
        elRewardsTbody.appendChild(tr);
        return;
      }

      arr.forEach((r) => {
        const tr = document.createElement('tr');

        const tdTitle = document.createElement('td');
        const title = String(r.title || '—');
        const valueText = String(r.valueText || '');
        tdTitle.textContent = valueText ? `${title} • ${valueText}` : title;

        const tdTier = document.createElement('td');
        tdTier.textContent = String(r.tier || '—').toUpperCase();

        const tdStock = document.createElement('td');
        tdStock.className = 'num';
        tdStock.textContent = String(Number(r.stock) || 0);

        const tdStatus = document.createElement('td');
        const st = rewardStatusLabel(r);
        const b = document.createElement('span');
        b.className = `badge ${st.variant}`.trim();
        b.textContent = st.text;
        tdStatus.appendChild(b);

        tr.appendChild(tdTitle);
        tr.appendChild(tdTier);
        tr.appendChild(tdStock);
        tr.appendChild(tdStatus);

        elRewardsTbody.appendChild(tr);
      });
    }

    function renderPartnerStats(stats) {
      setText(elPCreated, stats ? String(stats.created ?? '—') : '—');
      setText(elPRedeemed, stats ? String(stats.redeemed ?? '—') : '—');
      setText(elPActiveRewards, stats ? String(stats.activeRewards ?? '—') : '—');
      setText(elPOutStock, stats ? String(stats.outOfStockRewards ?? '—') : '—');
    }

    async function selectPartner(partnerId) {
      if (!requireKeyOrWarn()) return;

      const pid = String(partnerId || '').trim();
      if (!pid) return;

      state.selectedPartnerId = pid;
      setText(elPartnerDetailSub, `Laddar: ${pid}…`);
      setText(elDetailPartnerBadge, pid);

      // fetch rewards + stats parallel
      const wh = String(elWindowHours?.value || '24');
      const p1 = apiGet(`/admin/partners/${encodeURIComponent(pid)}/rewards`);
      const p2 = apiGet(`/admin/stats/partner/${encodeURIComponent(pid)}?windowHours=${encodeURIComponent(wh)}`);

      const [rewardsRes, statsRes] = await Promise.all([p1, p2]);

      if (!rewardsRes.ok || !rewardsRes.data || rewardsRes.data.ok !== true) {
        if (isDbMissingTable(rewardsRes.data)) toast(`DB saknar tabell: vouchers (rid: ${rewardsRes.data.rid || '—'})`, 'danger');
        setText(elPartnerDetailSub, `Kunde inte hämta rewards för ${pid}.`);
        renderRewardsTable([]);
      } else {
        renderRewardsTable(rewardsRes.data.rewards || []);
      }

      if (!statsRes.ok || !statsRes.data || statsRes.data.ok !== true) {
        if (isDbMissingTable(statsRes.data)) toast(`DB saknar tabell: vouchers (rid: ${statsRes.data.rid || '—'})`, 'danger');
        renderPartnerStats(null);
      } else {
        renderPartnerStats(statsRes.data);
      }

      setText(elPartnerDetailSub, `Partner: ${pid}`);
    }

    /* ============================================================
       BLOCK 7 — Actions: fetch all / create partner / invite
    ============================================================ */
    async function fetchAll() {
      if (!requireKeyOrWarn()) return;

      toast('Hämtar data…', 'info');

      const wh = String(elWindowHours?.value || '24');

      const [partnersRes, ovRes] = await Promise.all([
        apiGet('/admin/partners/list'),
        apiGet(`/admin/stats/overview?windowHours=${encodeURIComponent(wh)}`)
      ]);

      if (!partnersRes.ok || !partnersRes.data || partnersRes.data.ok !== true) {
        toast('Kunde inte hämta partners (fel admin key eller CORS).', 'danger');
        state.partners = [];
        renderPartnersList([]);
        renderInviteSelect([]);
      } else {
        state.partners = partnersRes.data.partners || [];
        renderPartnersList(state.partners);
        renderInviteSelect(state.partners);
      }

      if (!ovRes.ok || !ovRes.data || ovRes.data.ok !== true) {
        if (isDbMissingTable(ovRes.data)) {
          toast(`DB saknar tabell: vouchers (rid: ${ovRes.data.rid || '—'})`, 'danger');
        } else {
          toast('Kunde inte hämta översikt (kontrollera vouchers-tabell + admin key).', 'warn');
        }
        renderOverview(null);
      } else {
        renderOverview(ovRes.data);
        toast('Data uppdaterad.', 'success');
      }

      // re-render selected partner if any
      if (state.selectedPartnerId) {
        selectPartner(state.selectedPartnerId);
      }
    }

    async function createPartner() {
      if (!requireKeyOrWarn()) return;

      const partnerId = String(elCreatePartnerId?.value || '').trim();
      const name = String(elCreatePartnerName?.value || '').trim();

      if (!partnerId || !name) {
        toast('PartnerId och Namn krävs.', 'warn');
        return;
      }

      toast('Skapar partner…', 'info');

      const out = await apiPost('/admin/partners/create', { partnerId, name });

      if (!out.ok || !out.data || out.data.ok !== true) {
        toast('Kunde inte skapa partner (id kan redan finnas).', 'danger');
        return;
      }

      toast('Partner skapad.', 'success');
      if (elCreatePartnerId) elCreatePartnerId.value = '';
      if (elCreatePartnerName) elCreatePartnerName.value = '';

      // refresh
      fetchAll();
    }

    async function createInvite() {
      if (!requireKeyOrWarn()) return;

      const partnerId = String(elInvitePartnerSelect?.value || '').trim();
      const ttlMinutes = Number(elInviteTtl?.value || 0);

      if (!partnerId) {
        toast('Välj PartnerId.', 'warn');
        return;
      }
      if (!Number.isFinite(ttlMinutes) || ttlMinutes < 1) {
        toast('TTL måste vara ett tal > 0.', 'warn');
        return;
      }

      setText(elInviteMsg, 'Skapar invite…');

      const out = await apiPost('/admin/partners/invite', { partnerId, ttlMinutes });

      if (!out.ok || !out.data || out.data.ok !== true || !out.data.inviteToken) {
        setText(elInviteMsg, 'Kunde inte skapa invite.');
        toast('Invite misslyckades (fel partnerId eller admin key).', 'danger');
        return;
      }

      const url = buildInviteUrl(out.data.inviteToken);
      state.lastInviteUrl = url;

      if (elInviteUrlInput) elInviteUrlInput.value = url;
      setText(elInviteMsg, 'Invite skapad.');

      toast('Invite skapad.', 'success');
    }

    /* ============================================================
       BLOCK 8 — Events + boot
    ============================================================ */
    (function boot() {
      // session id (UI-only)
      const sid = String(Math.random()).slice(2, 7);
      setText(elSessionId, sid);

      if (elFetchBtn) elFetchBtn.addEventListener('click', fetchAll);
      if (elWindowHours) elWindowHours.addEventListener('change', () => {
        // update overview (and partner stats if selected)
        fetchAll();
      });

      if (elCreatePartnerBtn) elCreatePartnerBtn.addEventListener('click', createPartner);
      if (elCreateInviteBtn) elCreateInviteBtn.addEventListener('click', createInvite);

      if (elInviteCopyBtn) {
        elInviteCopyBtn.addEventListener('click', async () => {
          const link = String(elInviteUrlInput?.value || '');
          if (!link) { setText(elInviteMsg, 'Ingen länk att kopiera.'); return; }
          const ok = await copyText(link, elInviteUrlInput);
          setText(elInviteMsg, ok ? 'Kopierad.' : 'Kopiering nekades. Markera och kopiera manuellt.');
        });
      }

      // fail-closed: vi fetch:ar inte automatiskt utan key
      toast('Klart. Ange Admin Key och klicka “Hämta data”.', 'info');
    })();
  </script>
</body>
</html>
