<!-- ============================================================
     FIL: index.html  (HEL FIL)
     AO 1/15 + AO 11/15 (PATCH) + UI-polish (autostart cleanup)
     AO 5/6 (FAS 1.2) ‚Äî Admin entry link (topbar)
     PATCH (FAS 2.1) ‚Äî Mina skattjakter (spelkort) fr√•n PARTY_LIBRARY_V1
     M√•l: Visa statiska l√§gen + egen rad under Skattjakt med publicerade jakter
============================================================ -->
<!doctype html>
<html lang="sv">
<head>
  <!-- ==========================================================
       BLOCK 1 ‚Äî Meta + CSS
  =========================================================== -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Naturjakt / Skattjakt ‚Äî Start</title>
  <meta name="description" content="V√§lj l√§ge och starta spelet." />
  <link rel="stylesheet" href="styles/main.css" />
</head>

<body>
  <!-- ==========================================================
       BLOCK 2 ‚Äî App Root
  =========================================================== -->
  <div id="app" class="app"> <!-- HOOK: app-root -->
    <header class="topbar">
      <div class="topbar__inner">
        <div class="brand">
          <div class="brand__mark" aria-hidden="true">‚óé</div>
          <div class="brand__text">
            <div class="brand__name">Jakt-spelet</div>
            <div class="brand__tag muted">Mobil-first ‚Ä¢ UI-only baseline</div>
          </div>
        </div>

        <div class="topbar__right">
          <!-- ======================================================
               AO 5/6 (FAS 1.2) ‚Äî Admin link
               - Direkt l√§nk (ingen nav-motor i MVP)
               - Relativ path fr√•n /uppdrag/index.html ‚Üí /uppdrag/pages/admin.html
          ======================================================= -->
          <a id="adminLink"
             class="badge"
             href="pages/admin.html"
             aria-label="√ñppna admin f√∂r att skapa skattjakt">
            Admin
          </a>
          <!-- HOOK: admin-link -->

          <span class="badge badge-success">MVP</span>
        </div>
      </div>
    </header>

    <main class="main">
      <!-- ========================================================
           BLOCK 3 ‚Äî Start View (Mode-val)
      ========================================================= -->
      <section id="startView" class="view view--active" aria-label="Start"> <!-- HOOK: view-start -->
        <div class="container">
          <div class="hero">
            <h1 class="h1">V√§lj l√§ge</h1>
            <p class="lead muted">V√§lj ett l√§ge och tryck Starta.</p>
          </div>

          <!-- ======================================================
               BLOCK 3.1 ‚Äî Error slot (AO-11)
               KRAV: err= visas som Error Card p√• index
          ======================================================= -->
          <div id="errorSlot" class="slot"> <!-- HOOK: error-slot --></div>

          <div class="grid grid--modes" role="list">
            <article class="card card--mode" role="listitem" tabindex="0"
                     data-mode-card="zone"> <!-- HOOK: select-mode-zone -->
              <div class="card__top">
                <div class="card__icon" aria-hidden="true">üåø</div>
                <div class="card__meta">
                  <h2 class="card__title">Naturjakt</h2>
                  <p class="card__desc muted">Hitta och fota saker i naturen. Samla po√§ng och XP.</p>
                </div>
              </div>
              <div class="card__bottom">
                <span class="badge">Utomhus</span>
                <span class="badge badge-success">Demo: Skogsrundan</span>
              </div>
            </article>

            <article class="card card--mode" role="listitem" tabindex="0"
                     data-mode-card="party"> <!-- HOOK: select-mode-party -->
              <div class="card__top">
                <div class="card__icon" aria-hidden="true">üó∫Ô∏è</div>
                <div class="card__meta">
                  <h2 class="card__title">Skattjakt</h2>
                  <p class="card__desc muted">F√∂lj checkpoints och ledtr√•dar. Perfekt f√∂r kalas.</p>
                </div>
              </div>
              <div class="card__bottom">
                <span class="badge">Kalas</span>
                <span class="badge badge-success">Demo: Kalas</span>
              </div>
            </article>
          </div>

          <!-- ======================================================
               PATCH (FAS 2.1) ‚Äî Mina skattjakter (egen rad under Skattjakt)
               Renderas av JS om PARTY_LIBRARY_V1 har poster.
          ======================================================= -->
          <div id="partyLibraryWrap" class="slot" style="margin-top: var(--sp-5);">
            <!-- HOOK: party-library-wrap -->
          </div>

          <div class="panel">
            <div class="panel__row">
              <div class="panel__left">
                <div class="label muted">Valt l√§ge</div>
                <div id="selectedModeLabel" class="value">Inget valt</div> <!-- HOOK: selected-mode-label -->
              </div>

              <div class="panel__right">
                <button id="startBtn" class="btn btn-primary" type="button" disabled>
                  Starta
                </button>
                <!-- HOOK: start-button -->
              </div>
            </div>

            <div id="startHint" class="hint muted" role="status" aria-live="polite">
              V√§lj ett l√§ge f√∂r att aktivera Starta.
            </div>
            <!-- HOOK: hint-area -->
          </div>

          <footer class="footer muted">
            <span>Tips: QR kan starta direkt via URL (p√• samma base path).</span>
          </footer>
        </div>
      </section>
    </main>
  </div>

  <!-- ==========================================================
       BLOCK 5 ‚Äî Boot routing
       - K√∂r alltid; g√∂r inget om inga params finns.
  =========================================================== -->
  <script type="module" src="./src/boot.js"></script>

  <!-- ==========================================================
       BLOCK 6 ‚Äî Index controller (mode-select + Start links + err-card + library)
  =========================================================== -->
  <script type="module">
    import { qsGet } from './src/util.js';
    import { renderErrorCard, toast } from './src/ui.js';

    (function () {
      'use strict';

      if (window.__AO11_INDEX_INIT__) return; // HOOK: init-guard-index
      window.__AO11_INDEX_INIT__ = true;

      const PARTY_LIBRARY_KEY = 'PARTY_LIBRARY_V1'; // HOOK: party-library-key
      const partyLibraryWrap = document.getElementById('partyLibraryWrap'); // HOOK: party-library-wrap

      const selectedModeLabel = document.getElementById('selectedModeLabel'); // HOOK: selected-mode-label
      const startBtn = document.getElementById('startBtn'); // HOOK: start-button
      const startHint = document.getElementById('startHint'); // HOOK: hint-area
      const errorSlot = document.getElementById('errorSlot'); // HOOK: error-slot

      function currentBaseUrl() {
        // Om vi √§r p√• /uppdrag/index.html => base blir /uppdrag/
        const u = new URL(window.location.href);
        const p = u.pathname;
        u.pathname = p.endsWith('/') ? p : p.substring(0, p.lastIndexOf('/') + 1);
        u.search = '';
        u.hash = '';
        return u;
      }

      function safeJSONParse(str, fallback = null) {
        try { return JSON.parse(str); } catch (_) { return fallback; }
      }

      function readPartyLibrary() {
        try {
          const raw = localStorage.getItem(PARTY_LIBRARY_KEY);
          if (!raw) return [];
          const v = safeJSONParse(raw, []);
          if (!Array.isArray(v)) return [];
          return v
            .filter((x) => x && typeof x === 'object' && typeof x.id === 'string')
            .map((x) => ({
              id: String(x.id),
              name: String(x.name || 'Skattjakt'),
              checkpointCount: Number(x.checkpointCount || 0),
              updatedAt: Number(x.updatedAt || 0)
            }));
        } catch (_) {
          return [];
        }
      }

      function renderPartyLibraryRow() {
        if (!partyLibraryWrap) return;

        const list = readPartyLibrary();
        if (!list.length) {
          partyLibraryWrap.innerHTML = '';
          return;
        }

        list.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));

        const section = document.createElement('section');
        section.className = 'card';
        section.setAttribute('aria-label', 'Mina skattjakter');

        const head = document.createElement('div');
        head.className = 'card__head';

        const meta = document.createElement('div');
        meta.className = 'card__meta';

        const h = document.createElement('h2');
        h.className = 'h2';
        h.style.margin = '0';
        h.textContent = 'Mina skattjakter';

        const p = document.createElement('p');
        p.className = 'muted small';
        p.style.margin = '6px 0 0 0';
        p.textContent = 'Publicerade fr√•n Admin p√• denna enhet. Klicka f√∂r att √∂ppna/redigera.';

        meta.appendChild(h);
        meta.appendChild(p);
        head.appendChild(meta);

        const grid = document.createElement('div');
        grid.className = 'grid grid--modes';
        grid.style.marginTop = '12px';

        // L√§nk: √∂ppna admin med load=<id>
        const base = currentBaseUrl();
        const adminBase = new URL('pages/admin.html', base.toString());

        for (const item of list) {
          const a = document.createElement('a');
          a.className = 'card card--mode';
          a.setAttribute('role', 'listitem');
          a.setAttribute('tabindex', '0');
          a.style.display = 'block';

          const url = new URL(adminBase.toString());
          url.searchParams.set('load', item.id);
          a.href = url.toString();

          const top = document.createElement('div');
          top.className = 'card__top';

          const icon = document.createElement('div');
          icon.className = 'card__icon';
          icon.setAttribute('aria-hidden', 'true');
          icon.textContent = 'üéØ';

          const meta2 = document.createElement('div');
          meta2.className = 'card__meta';

          const title = document.createElement('h3');
          title.className = 'card__title';
          title.textContent = item.name;

          const desc = document.createElement('p');
          desc.className = 'card__desc muted';
          desc.textContent = item.checkpointCount
            ? `${item.checkpointCount} checkpoints ‚Ä¢ √∂ppna i admin`
            : '√ñppna i admin';

          meta2.appendChild(title);
          meta2.appendChild(desc);

          top.appendChild(icon);
          top.appendChild(meta2);

          const bottom = document.createElement('div');
          bottom.className = 'card__bottom';

          const b1 = document.createElement('span');
          b1.className = 'badge';
          b1.textContent = 'Skattjakt';

          const b2 = document.createElement('span');
          b2.className = 'badge badge-success';
          b2.textContent = 'Min karta';

          bottom.appendChild(b1);
          bottom.appendChild(b2);

          a.appendChild(top);
          a.appendChild(bottom);

          a.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              window.location.assign(a.href);
            }
          });

          grid.appendChild(a);
        }

        section.appendChild(head);
        section.appendChild(grid);

        partyLibraryWrap.innerHTML = '';
        partyLibraryWrap.appendChild(section);
      }

      // =========================================================
      // KRAV: err= visas som Error Card p√• index
      // =========================================================
      const err = qsGet('err'); // HOOK: qs-err
      const rid = qsGet('rid'); // HOOK: qs-rid
      if (err && errorSlot) {
        const msg = rid
          ? `Start kunde inte genomf√∂ras. Felkod: ${err} (rid: ${rid})`
          : `Start kunde inte genomf√∂ras. Felkod: ${err}`;

        const card = renderErrorCard(msg, [
          {
            label: 'Rensa fel',
            variant: 'ghost',
            onClick: () => {
              const url = new URL(window.location.href);
              url.searchParams.delete('err');
              url.searchParams.delete('rid');
              window.history.replaceState({}, '', url.toString());
              errorSlot.innerHTML = '';
            }
          }
        ]);

        errorSlot.innerHTML = '';
        errorSlot.appendChild(card);
      }

      // =========================================================
      // Render ‚ÄúMina skattjakter‚Äù
      // =========================================================
      renderPartyLibraryRow();

      // =========================================================
      // Om URL redan har mode+id: visa bara l√§tt feedback.
      // Boot.js routar vidare direkt.
      // =========================================================
      const qsMode = qsGet('mode');
      const qsId = qsGet('id');
      if (qsMode && qsId) {
        try { toast('Startar‚Ä¶', 'info', { ttlMs: 900 }); } catch (_) {}
        if (startHint) startHint.textContent = 'Startar‚Ä¶';
        if (startBtn) {
          startBtn.disabled = true;
          startBtn.textContent = 'Startar‚Ä¶';
        }
        return;
      }

      // =========================================================
      // Mode selection + Start links (samma base path)
      // =========================================================
      let selectedMode = '';

      function setSelectedMode(nextMode) {
        selectedMode = (nextMode || '').trim();

        if (selectedModeLabel) {
          selectedModeLabel.textContent =
            selectedMode === 'zone' ? 'Naturjakt (zon)' :
            selectedMode === 'party' ? 'Skattjakt (party)' :
            'Inget valt';
        }

        if (startBtn) startBtn.disabled = !selectedMode;

        if (startHint) {
          startHint.textContent = selectedMode
            ? 'Tryck Starta f√∂r att √∂ppna demo via QR-l√§nk.'
            : 'V√§lj ett l√§ge f√∂r att aktivera Starta.';
        }

        document.querySelectorAll('[data-mode-card]').forEach((el) => {
          const isActive = el.getAttribute('data-mode-card') === selectedMode;
          el.classList.toggle('is-selected', isActive);
          el.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });
      }

      document.querySelectorAll('[data-mode-card]').forEach((card) => {
        card.addEventListener('click', () => {
          const m = (card.getAttribute('data-mode-card') || '').trim();
          setSelectedMode(m);
        });
        card.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            const m = (card.getAttribute('data-mode-card') || '').trim();
            setSelectedMode(m);
          }
        });
      });

      if (startBtn) {
        startBtn.addEventListener('click', () => {
          if (!selectedMode) return;

          const id = selectedMode === 'zone' ? 'skogsrundan'
                   : selectedMode === 'party' ? 'kalas_demo'
                   : '';
          if (!id) return;

          startBtn.disabled = true;
          startBtn.textContent = 'Startar‚Ä¶';
          if (startHint) startHint.textContent = 'Startar‚Ä¶';
          try { toast('Startar‚Ä¶', 'info', { ttlMs: 900 }); } catch (_) {}

          const base = currentBaseUrl();
          base.searchParams.set('mode', selectedMode);
          base.searchParams.set('id', id);

          window.location.assign(base.toString());
        });
      }
    })();
  </script>
</body>
</html>
