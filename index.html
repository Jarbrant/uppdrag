<!-- ============================================================
     FIL: index.html  (HEL FIL)
     PATCH: Mina skattjakter ‚Äî ‚ÄúSkattjakt‚Äù √∂ppnar Bjud in-modal (QR/l√§nk),
            ‚ÄúMin karta‚Äù √∂ppnar Admin (redigera)
     Policy: UI-only, XSS-safe, fail-closed, subpath-safe
============================================================ -->
<!doctype html>
<html lang="sv">
<head>
  <!-- ==========================================================
       BLOCK 1 ‚Äî Meta + CSS
  =========================================================== -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Naturjakt / Skattjakt ‚Äî Start</title>
  <meta name="description" content="V√§lj l√§ge och starta spelet." />
  <link rel="stylesheet" href="styles/main.css" />
</head>

<body>
  <!-- ==========================================================
       BLOCK 2 ‚Äî App Root
  =========================================================== -->
  <div id="app" class="app"> <!-- HOOK: app-root -->
    <header class="topbar">
      <div class="topbar__inner">
        <div class="brand">
          <div class="brand__mark" aria-hidden="true">‚óé</div>
          <div class="brand__text">
            <div class="brand__name">Jakt-spelet</div>
            <div class="brand__tag muted">Mobil-first ‚Ä¢ UI-only baseline</div>
          </div>
        </div>

        <div class="topbar__right">
          <!-- ======================================================
               AO 5/6 (FAS 1.2) ‚Äî Admin link
          ======================================================= -->
          <a id="adminLink"
             class="badge"
             href="pages/admin.html"
             aria-label="√ñppna admin f√∂r att skapa skattjakt">
            Admin
          </a>
          <!-- HOOK: admin-link -->
          <span class="badge badge-success">MVP</span>
        </div>
      </div>
    </header>

    <main class="main">
      <!-- ========================================================
           BLOCK 3 ‚Äî Start View (Mode-val)
      ========================================================= -->
      <section id="startView" class="view view--active" aria-label="Start"> <!-- HOOK: view-start -->
        <div class="container">
          <div class="hero">
            <h1 class="h1">V√§lj l√§ge</h1>
            <p class="lead muted">V√§lj ett l√§ge och tryck Starta.</p>
          </div>

          <!-- ======================================================
               BLOCK 3.1 ‚Äî Error slot (AO-11)
          ======================================================= -->
          <div id="errorSlot" class="slot"> <!-- HOOK: error-slot --></div>

          <div class="grid grid--modes" role="list">
            <article class="card card--mode" role="listitem" tabindex="0"
                     data-mode-card="zone"> <!-- HOOK: select-mode-zone -->
              <div class="card__top">
                <div class="card__icon" aria-hidden="true">üåø</div>
                <div class="card__meta">
                  <h2 class="card__title">Naturjakt</h2>
                  <p class="card__desc muted">Hitta och fota saker i naturen. Samla po√§ng och XP.</p>
                </div>
              </div>
              <div class="card__bottom">
                <span class="badge">Utomhus</span>
                <span class="badge badge-success">Demo: Skogsrundan</span>
              </div>
            </article>

            <article class="card card--mode" role="listitem" tabindex="0"
                     data-mode-card="party"> <!-- HOOK: select-mode-party -->
              <div class="card__top">
                <div class="card__icon" aria-hidden="true">üó∫Ô∏è</div>
                <div class="card__meta">
                  <h2 class="card__title">Skattjakt</h2>
                  <p class="card__desc muted">F√∂lj checkpoints och ledtr√•dar. Perfekt f√∂r kalas.</p>
                </div>
              </div>
              <div class="card__bottom">
                <span class="badge">Kalas</span>
                <span class="badge badge-success">Demo: Kalas</span>
              </div>
            </article>
          </div>

          <!-- ======================================================
               Mina skattjakter (renderas av JS)
          ======================================================= -->
          <div id="partyLibraryWrap" class="slot" style="margin-top: var(--sp-5);">
            <!-- HOOK: party-library-wrap -->
          </div>

          <div class="panel">
            <div class="panel__row">
              <div class="panel__left">
                <div class="label muted">Valt l√§ge</div>
                <div id="selectedModeLabel" class="value">Inget valt</div> <!-- HOOK: selected-mode-label -->
              </div>

              <div class="panel__right">
                <button id="startBtn" class="btn btn-primary" type="button" disabled>
                  Starta
                </button>
                <!-- HOOK: start-button -->
              </div>
            </div>

            <div id="startHint" class="hint muted" role="status" aria-live="polite">
              V√§lj ett l√§ge f√∂r att aktivera Starta.
            </div>
            <!-- HOOK: hint-area -->
          </div>

          <footer class="footer muted">
            <span>Tips: QR kan starta direkt via URL (p√• samma base path).</span>
          </footer>
        </div>
      </section>
    </main>

    <!-- ==========================================================
         BLOCK 4 ‚Äî Invite Modal (f√∂r ‚ÄúSkattjakt‚Äù-knappen i Mina skattjakter)
    =========================================================== -->
    <div id="inviteOverlay"
         style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:9999; padding:16px;"
         aria-hidden="true">
      <div id="inviteModal"
           role="dialog"
           aria-modal="true"
           aria-labelledby="inviteTitle"
           style="max-width:720px; margin:40px auto; background:rgba(10,18,30,.98); border:1px solid rgba(255,255,255,.10); border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.45); overflow:hidden;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding:16px 16px 12px 16px;">
          <div>
            <div id="inviteTitle" style="font-weight:700; font-size:18px;">Bjud in till Skattjakt</div>
            <div id="inviteSub" class="muted" style="margin-top:4px;">Dela l√§nken eller l√•t andra skanna QR.</div>
          </div>
          <button id="inviteCloseBtn" type="button" class="btn btn-ghost miniBtn" aria-label="St√§ng">
            St√§ng
          </button>
        </div>

        <div style="padding:0 16px 16px 16px; display:grid; gap:14px;">
          <div class="card" style="padding:12px;">
            <div class="muted small" style="margin-bottom:8px;">QR-kod</div>
            <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
              <img id="inviteQrImg" alt="QR f√∂r Skattjakt" style="width:200px; height:200px; border-radius:12px; background:rgba(255,255,255,.06); display:block;" />
              <div style="flex:1; min-width:220px; display:grid; gap:8px;">
                <div class="muted small">L√§nk</div>
                <input id="inviteLinkInput" class="input" type="text" readonly value="" />
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <button id="inviteCopyBtn" type="button" class="btn btn-ghost miniBtn">Kopiera l√§nk</button>
                  <button id="inviteShareBtn" type="button" class="btn btn-ghost miniBtn">Dela</button>
                </div>
                <div id="inviteMsg" class="muted small" style="min-height:18px;"></div>
              </div>
            </div>
          </div>

          <div class="card" style="padding:12px;">
            <div class="muted small" style="margin-bottom:8px;">Spelare (bara p√• denna enhet)</div>

            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
              <input id="inviteNameInput" class="input" type="text" placeholder="Skriv namn‚Ä¶" style="flex:1; min-width:200px;" />
              <button id="inviteAddBtn" type="button" class="btn btn-primary miniBtn">L√§gg till</button>
            </div>

            <ul id="inviteList" style="list-style:none; padding:0; margin:12px 0 0 0; display:grid; gap:8px;"></ul>
          </div>

          <div class="muted small">
            Obs: I MVP kan vi inte ‚Äúskicka‚Äù inbjudan. QR/l√§nk √§r det som fungerar.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==========================================================
       BLOCK 5 ‚Äî Boot routing
  =========================================================== -->
  <script type="module" src="./src/boot.js"></script>

  <!-- ==========================================================
       BLOCK 6 ‚Äî Index controller
  =========================================================== -->
  <script type="module">
    import { qsGet } from './src/util.js';
    import { renderErrorCard, toast } from './src/ui.js';

    (function () {
      'use strict';

      if (window.__AO11_INDEX_INIT__) return;
      window.__AO11_INDEX_INIT__ = true;

      const PARTY_LIBRARY_KEY = 'PARTY_LIBRARY_V1';
      const partyLibraryWrap = document.getElementById('partyLibraryWrap');

      const selectedModeLabel = document.getElementById('selectedModeLabel');
      const startBtn = document.getElementById('startBtn');
      const startHint = document.getElementById('startHint');
      const errorSlot = document.getElementById('errorSlot');

      // Invite modal hooks
      const inviteOverlay = document.getElementById('inviteOverlay');
      const inviteCloseBtn = document.getElementById('inviteCloseBtn');
      const inviteQrImg = document.getElementById('inviteQrImg');
      const inviteLinkInput = document.getElementById('inviteLinkInput');
      const inviteCopyBtn = document.getElementById('inviteCopyBtn');
      const inviteShareBtn = document.getElementById('inviteShareBtn');
      const inviteMsg = document.getElementById('inviteMsg');
      const inviteNameInput = document.getElementById('inviteNameInput');
      const inviteAddBtn = document.getElementById('inviteAddBtn');
      const inviteList = document.getElementById('inviteList');

      // UI-only: inga nya storage keys ‚Äî listan √§r bara i minnet
      const invitePlayers = [];

      const MAX_INLINE_QS_CHARS = 1400; // samma ‚Äúf√∂r stor‚Äù-policy som admin

      function currentBaseUrl() {
        const u = new URL(window.location.href);
        const p = u.pathname;
        u.pathname = p.endsWith('/') ? p : p.substring(0, p.lastIndexOf('/') + 1);
        u.search = '';
        u.hash = '';
        return u;
      }

      function safeJSONParse(str, fallback = null) {
        try { return JSON.parse(str); } catch (_) { return fallback; }
      }

      function readPartyLibraryRaw() {
        try {
          const raw = localStorage.getItem(PARTY_LIBRARY_KEY);
          if (!raw) return [];
          const v = safeJSONParse(raw, []);
          if (!Array.isArray(v)) return [];
          return v.filter((x) => x && typeof x === 'object' && typeof x.id === 'string');
        } catch (_) {
          return [];
        }
      }

      function readPartyLibraryForList() {
        const v = readPartyLibraryRaw();
        return v.map((x) => ({
          id: String(x.id),
          name: String(x.name || 'Skattjakt'),
          checkpointCount: Number(x.checkpointCount || 0),
          updatedAt: Number(x.updatedAt || 0)
        }));
      }

      function findLibraryEntry(id) {
        const list = readPartyLibraryRaw();
        return list.find((x) => x && String(x.id) === String(id)) || null;
      }

      // =========================
      // Invite modal helpers
      // =========================
      function qrImgUrlFor(text) {
        const size = 220;
        const enc = encodeURIComponent(text);
        return `https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${enc}`;
      }

      function setInviteMsg(msg) {
        if (!inviteMsg) return;
        inviteMsg.textContent = msg || '';
      }

      function renderInvitePlayers() {
        if (!inviteList) return;
        inviteList.innerHTML = '';

        if (!invitePlayers.length) {
          const li = document.createElement('li');
          li.className = 'muted small';
          li.textContent = 'Inga spelare tillagda √§nnu.';
          inviteList.appendChild(li);
          return;
        }

        invitePlayers.forEach((name, idx) => {
          const li = document.createElement('li');
          li.style.display = 'flex';
          li.style.alignItems = 'center';
          li.style.justifyContent = 'space-between';
          li.style.gap = '10px';
          li.style.padding = '10px';
          li.style.border = '1px solid rgba(255,255,255,.10)';
          li.style.borderRadius = '12px';
          li.style.background = 'rgba(255,255,255,.04)';

          const left = document.createElement('div');
          left.textContent = name;

          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-ghost miniBtn';
          btn.textContent = 'Ta bort';
          btn.addEventListener('click', () => {
            invitePlayers.splice(idx, 1);
            renderInvitePlayers();
          });

          li.appendChild(left);
          li.appendChild(btn);
          inviteList.appendChild(li);
        });
      }

      function buildPartyInviteLinkFromPayload(payloadJSON) {
        // Deltagarvyn ska startas via payload (som admin export g√∂r)
        const encoded = encodeURIComponent(String(payloadJSON || ''));
        if (!encoded || encoded.length > MAX_INLINE_QS_CHARS) {
          return { ok: false, reason: 'too-large', len: encoded.length || 0 };
        }

        const base = currentBaseUrl();
        const u = new URL('party.html', base.toString());
        u.searchParams.set('mode', 'party');
        u.searchParams.set('payload', encoded);
        return { ok: true, url: u.toString() };
      }

      function openInviteModalForLibraryId(libraryId, titleName) {
        if (!inviteOverlay) return;

        const entry = findLibraryEntry(libraryId);
        const payloadJSON = entry && typeof entry.payloadJSON === 'string' ? entry.payloadJSON : '';

        if (!payloadJSON) {
          setInviteMsg('Hittade ingen delbar data. √ñppna i Admin och anv√§nd ‚ÄúKopiera JSON‚Äù.');
          if (inviteLinkInput) inviteLinkInput.value = '';
          if (inviteQrImg) inviteQrImg.removeAttribute('src');
        } else {
          const built = buildPartyInviteLinkFromPayload(payloadJSON);
          if (!built.ok) {
            setInviteMsg('Den h√§r kartan √§r f√∂r stor f√∂r l√§nk/QR. √ñppna i Admin och anv√§nd ‚ÄúKopiera JSON‚Äù.');
            if (inviteLinkInput) inviteLinkInput.value = '';
            if (inviteQrImg) inviteQrImg.removeAttribute('src');
          } else {
            if (inviteLinkInput) inviteLinkInput.value = built.url;
            if (inviteQrImg) inviteQrImg.src = qrImgUrlFor(built.url);
            setInviteMsg('');
          }
        }

        // S√§tt titel om vi kan
        try {
          const t = document.getElementById('inviteTitle');
          if (t) t.textContent = `Bjud in till: ${String(titleName || 'Skattjakt')}`;
        } catch (_) {}

        renderInvitePlayers();

        inviteOverlay.style.display = 'block';
        inviteOverlay.setAttribute('aria-hidden', 'false');
        try { (inviteNameInput || inviteCloseBtn || inviteOverlay).focus(); } catch (_) {}
      }

      function closeInviteModal() {
        if (!inviteOverlay) return;
        inviteOverlay.style.display = 'none';
        inviteOverlay.setAttribute('aria-hidden', 'true');
        setInviteMsg('');
      }

      if (inviteCloseBtn) inviteCloseBtn.addEventListener('click', closeInviteModal);

      if (inviteOverlay) {
        inviteOverlay.addEventListener('click', (e) => {
          if (e.target === inviteOverlay) closeInviteModal();
        });
      }

      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeInviteModal();
      });

      async function copyText(text, fallbackInput) {
        try {
          if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
            await navigator.clipboard.writeText(text);
            return true;
          }
        } catch (_) {}
        if (fallbackInput) {
          try {
            fallbackInput.focus();
            fallbackInput.select();
            fallbackInput.setSelectionRange(0, String(fallbackInput.value || '').length);
          } catch (_) {}
        }
        return false;
      }

      if (inviteCopyBtn) {
        inviteCopyBtn.addEventListener('click', async () => {
          const link = (inviteLinkInput && inviteLinkInput.value) ? inviteLinkInput.value : '';
          if (!link) { setInviteMsg('Ingen l√§nk att kopiera.'); return; }
          const ok = await copyText(link, inviteLinkInput);
          setInviteMsg(ok ? 'L√§nk kopierad.' : 'Kopiering nekades. Markera l√§nken och kopiera manuellt.');
        });
      }

      if (inviteShareBtn) {
        inviteShareBtn.addEventListener('click', async () => {
          const link = (inviteLinkInput && inviteLinkInput.value) ? inviteLinkInput.value : '';
          if (!link) { setInviteMsg('Ingen l√§nk att dela.'); return; }
          try {
            if (navigator.share) {
              await navigator.share({ title: 'Skattjakt', text: 'H√§ng med p√• Skattjakt!', url: link });
              setInviteMsg('Delat.');
              return;
            }
          } catch (_) {}
          setInviteMsg('Dela st√∂ds inte h√§r. Kopiera l√§nken ist√§llet.');
        });
      }

      function addPlayerFromInput() {
        if (!inviteNameInput) return;
        const name = String(inviteNameInput.value || '').trim();
        if (name.length < 1) { setInviteMsg('Skriv ett namn.'); return; }
        if (name.length > 30) { setInviteMsg('Namn √§r f√∂r l√•ngt (max 30).'); return; }
        invitePlayers.push(name);
        inviteNameInput.value = '';
        setInviteMsg('Tillagd.');
        renderInvitePlayers();
      }

      if (inviteAddBtn) inviteAddBtn.addEventListener('click', addPlayerFromInput);
      if (inviteNameInput) {
        inviteNameInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') { e.preventDefault(); addPlayerFromInput(); }
        });
      }

      // =========================
      // Render ‚ÄúMina skattjakter‚Äù
      // =========================
      function renderPartyLibraryRow() {
        if (!partyLibraryWrap) return;

        const list = readPartyLibraryForList();
        if (!list.length) {
          partyLibraryWrap.innerHTML = '';
          return;
        }

        list.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));

        const section = document.createElement('section');
        section.className = 'card';
        section.setAttribute('aria-label', 'Mina skattjakter');

        const head = document.createElement('div');
        head.className = 'card__head';

        const meta = document.createElement('div');
        meta.className = 'card__meta';

        const h = document.createElement('h2');
        h.className = 'h2';
        h.style.margin = '0';
        h.textContent = 'Mina skattjakter';

        const p = document.createElement('p');
        p.className = 'muted small';
        p.style.margin = '6px 0 0 0';
        p.textContent = 'Publicerade fr√•n Admin p√• denna enhet. ‚ÄúMin karta‚Äù = redigera. ‚ÄúSkattjakt‚Äù = bjud in.';

        meta.appendChild(h);
        meta.appendChild(p);
        head.appendChild(meta);

        const grid = document.createElement('div');
        grid.className = 'grid grid--modes';
        grid.style.marginTop = '12px';

        const base = currentBaseUrl();
        const adminBase = new URL('pages/admin.html', base.toString());

        function goToAdminLoad(id) {
          const u = new URL(adminBase.toString());
          u.searchParams.set('load', String(id));
          window.location.assign(u.toString());
        }

        for (const item of list) {
          const card = document.createElement('div');
          card.className = 'card card--mode';
          card.setAttribute('role', 'listitem');
          card.setAttribute('tabindex', '0');
          card.style.display = 'block';

          // Valfritt: tryck p√• sj√§lva kortet √∂ppnar Admin
          card.addEventListener('click', (e) => {
            const t = e && e.target;
            const tag = (t && t.tagName) ? String(t.tagName).toUpperCase() : '';
            // Klick p√• knapparna ska inte trigga kort-klick
            if (tag === 'BUTTON') return;
            goToAdminLoad(item.id);
          });
          card.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              goToAdminLoad(item.id);
            }
          });

          const top = document.createElement('div');
          top.className = 'card__top';

          const icon = document.createElement('div');
          icon.className = 'card__icon';
          icon.setAttribute('aria-hidden', 'true');
          icon.textContent = 'üéØ';

          const meta2 = document.createElement('div');
          meta2.className = 'card__meta';

          const title = document.createElement('h3');
          title.className = 'card__title';
          title.textContent = item.name;

          const desc = document.createElement('p');
          desc.className = 'card__desc muted';
          desc.textContent = item.checkpointCount
            ? `${item.checkpointCount} checkpoints ‚Ä¢ √∂ppna i admin`
            : '√ñppna i admin';

          meta2.appendChild(title);
          meta2.appendChild(desc);

          top.appendChild(icon);
          top.appendChild(meta2);

          const bottom = document.createElement('div');
          bottom.className = 'card__bottom';

          // ‚ÄúSkattjakt‚Äù ‚Üí modal (bjud in)
          const btnInvite = document.createElement('button');
          btnInvite.type = 'button';
          btnInvite.className = 'badge';
          btnInvite.textContent = 'Skattjakt';
          btnInvite.setAttribute('aria-label', 'Bjud in till denna skattjakt');
          btnInvite.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            openInviteModalForLibraryId(item.id, item.name);
          });

          // ‚ÄúMin karta‚Äù ‚Üí admin redigera
          const btnEdit = document.createElement('button');
          btnEdit.type = 'button';
          btnEdit.className = 'badge badge-success';
          btnEdit.textContent = 'Min karta';
          btnEdit.setAttribute('aria-label', '√ñppna i admin och redigera');
          btnEdit.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            goToAdminLoad(item.id);
          });

          bottom.appendChild(btnInvite);
          bottom.appendChild(btnEdit);

          card.appendChild(top);
          card.appendChild(bottom);

          grid.appendChild(card);
        }

        section.appendChild(head);
        section.appendChild(grid);

        partyLibraryWrap.innerHTML = '';
        partyLibraryWrap.appendChild(section);
      }

      // =========================
      // err= ‚Üí error card
      // =========================
      const err = qsGet('err');
      const rid = qsGet('rid');
      if (err && errorSlot) {
        const msg = rid
          ? `Start kunde inte genomf√∂ras. Felkod: ${err} (rid: ${rid})`
          : `Start kunde inte genomf√∂ras. Felkod: ${err}`;

        const card = renderErrorCard(msg, [
          {
            label: 'Rensa fel',
            variant: 'ghost',
            onClick: () => {
              const url = new URL(window.location.href);
              url.searchParams.delete('err');
              url.searchParams.delete('rid');
              window.history.replaceState({}, '', url.toString());
              errorSlot.innerHTML = '';
            }
          }
        ]);

        errorSlot.innerHTML = '';
        errorSlot.appendChild(card);
      }

      // Render library
      renderPartyLibraryRow();

      // =========================
      // Autostart feedback (boot.js tar √∂ver)
      // =========================
      const qsMode = qsGet('mode');
      const qsId = qsGet('id');
      if (qsMode && qsId) {
        try { toast('Startar‚Ä¶', 'info', { ttlMs: 900 }); } catch (_) {}
        if (startHint) startHint.textContent = 'Startar‚Ä¶';
        if (startBtn) {
          startBtn.disabled = true;
          startBtn.textContent = 'Startar‚Ä¶';
        }
        return;
      }

      // =========================
      // Mode selection + Start
      // =========================
      let selectedMode = '';

      function setSelectedMode(nextMode) {
        selectedMode = (nextMode || '').trim();

        if (selectedModeLabel) {
          selectedModeLabel.textContent =
            selectedMode === 'zone' ? 'Naturjakt (zon)' :
            selectedMode === 'party' ? 'Skattjakt (party)' :
            'Inget valt';
        }

        if (startBtn) startBtn.disabled = !selectedMode;

        if (startHint) {
          startHint.textContent = selectedMode
            ? 'Tryck Starta f√∂r att √∂ppna demo via QR-l√§nk.'
            : 'V√§lj ett l√§ge f√∂r att aktivera Starta.';
        }

        document.querySelectorAll('[data-mode-card]').forEach((el) => {
          const isActive = el.getAttribute('data-mode-card') === selectedMode;
          el.classList.toggle('is-selected', isActive);
          el.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });
      }

      document.querySelectorAll('[data-mode-card]').forEach((card) => {
        card.addEventListener('click', () => {
          const m = (card.getAttribute('data-mode-card') || '').trim();
          setSelectedMode(m);
        });
        card.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            const m = (card.getAttribute('data-mode-card') || '').trim();
            setSelectedMode(m);
          }
        });
      });

      if (startBtn) {
        startBtn.addEventListener('click', () => {
          if (!selectedMode) return;

          const id = selectedMode === 'zone' ? 'skogsrundan'
                   : selectedMode === 'party' ? 'kalas_demo'
                   : '';
          if (!id) return;

          startBtn.disabled = true;
          startBtn.textContent = 'Startar‚Ä¶';
          if (startHint) startHint.textContent = 'Startar‚Ä¶';
          try { toast('Startar‚Ä¶', 'info', { ttlMs: 900 }); } catch (_) {}

          const base = currentBaseUrl();
          base.searchParams.set('mode', selectedMode);
          base.searchParams.set('id', id);

          window.location.assign(base.toString());
        });
      }
    })();
  </script>
</body>
</html>
